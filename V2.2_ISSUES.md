# HeartSafeAlerts v2.2 - Issues to Fix

**Created:** 2025-12-08
**Status:** In Progress

---

## Summary

Three alert-related issues need investigation before v2.2 release:

1. **Sound Alerts trigger vibration** (unexpected coupling)
2. **Vibration-only alerts are too weak** (barely perceptible)
3. **Background notifications don't show banner** (iOS 26 regression?)

---

## Issue 1: Sound Alerts Enable Vibration

**Symptom:** When "Sound Alerts" is ON and "Vibration Alerts" is OFF, the phone still vibrates when an alert fires.

**Expected:** Sound should play WITHOUT vibration.

**Investigation needed:**
- Check if `AudioServicesPlaySystemSound(Constants.alertSoundID)` includes vibration by default
- System sound 1304 may have built-in haptic feedback
- May need to use a different API or sound ID

**File:** `AlertManager.swift` lines 117-120

```swift
private func playLocalAlerts() {
    if soundAlertsEnabled {
        AudioServicesPlaySystemSound(Constants.alertSoundID)  // <-- This may vibrate too
    }
    ...
}
```

---

## Issue 2: Vibration-Only Alerts Are Too Weak

**Symptom:** When "Vibration Alerts" is ON (without sound), the vibration is barely perceptible - just a microsecond pulse that's easy to miss.

**Expected:** A strong, noticeable vibration pattern.

**Investigation needed:**
- Current implementation uses `UIImpactFeedbackGenerator(style: .heavy)` - single tap
- May need multiple pulses or a different approach
- Consider `UINotificationFeedbackGenerator` for more prominent feedback
- Or use `AudioServicesPlaySystemSound(kSystemSoundID_Vibrate)` for longer vibration

**File:** `AlertManager.swift` lines 122-126

```swift
if vibrationAlertsEnabled {
    let impactFeedback = UIImpactFeedbackGenerator(style: .heavy)
    impactFeedback.prepare()
    impactFeedback.impactOccurred()  // <-- Single tap, very brief
}
```

---

## Issue 3: Background Notifications Don't Show Banner (iOS 26)

**Symptom:** When "Background Notifications" is ON and heart rate goes out of range:
- Log shows: `ðŸ“± Showing notification while app is foreground`
- Sound plays (if enabled)
- But NO banner/toast appears on screen

**Expected:** A notification banner should appear at the top of the screen.

**Context:**
- This WORKED in v2.0 on iOS 18 (confirmed by App Store version)
- Broken on iOS 26 (developer beta)
- Code appears correct - delegate returns `[.banner, .sound, .badge]`
- May be iOS 26 regression or new requirement

**Investigation needed:**
- Research iOS 26 notification changes
- Check if new entitlements or permissions required
- Test on iOS 18 device if available to confirm it's iOS 26 specific
- May need to file Apple bug report

**File:** `AppDelegate.swift` lines 58-61

```swift
func userNotificationCenter(_ center: UNUserNotificationCenter, willPresent notification: UNNotification, withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {
    completionHandler([.banner, .sound, .badge])  // <-- Correct, but banner not showing
}
```

---

## Completed Today

- [x] Added HealthKit capability in Xcode (Apple Watch support)
- [x] Cleaned up code from Gemini's changes
- [x] Fixed `backgroundNotificationsEnabled` wiring (Settings toggle now works)
- [x] Removed `.timeSensitive` that required special entitlement
- [x] Reverted to UUID-based notification identifiers

---

## Test Plan for Tomorrow

1. **Test Apple Watch data source**
   - Select "Apple Watch" in Settings
   - Confirm HealthKit permission prompt appears
   - Verify heart rate data flows from watch

2. **Investigate Sound/Vibration coupling**
   - Research `AudioServicesPlaySystemSound` behavior
   - Test alternative sound APIs
   - Test alternative vibration patterns

3. **Investigate iOS 26 notifications**
   - Research iOS 26 beta notification changes
   - Check Apple developer forums
   - Test workarounds

---

## Files Changed (Uncommitted)

```
CARE_CIRCLE_IMPLEMENTATION.md
HeartSafeAlerts.xcodeproj/project.pbxproj
HeartSafeAlerts/AlertManager.swift
HeartSafeAlerts/AppDelegate.swift
HeartSafeAlerts/HealthKitManager.swift
HeartSafeAlerts/HeartRateMonitor.swift
HeartSafeAlerts/SettingsView.swift
HeartSafeAlerts/HeartSafeAlerts.entitlements (new)
```
